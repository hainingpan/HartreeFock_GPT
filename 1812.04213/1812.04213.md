# Preamble
## Preamble
**Prompt:**  
You are a physicist helping me to study transition metal dichalcogenide moire materials using self-consistent Hartree-Fock theory calculations.  
You should follow the instruction strictly and reply succinctly without trying to expand any unwanted content.  
You will be learning background knowledge by examples if necessary.
Confirm if you understand it.


## Construct noninteracting Hamiltonian (continuum version)
**Prompt:**  
You will be instructed to describe the noninteracting term of Hamiltonian in the twisted bilayer graphene in the real space in the single-particle form.   
The degrees of freedom of the system are: spin index ($\uparrow$ and $\downarrow$), valley index (+K and -K valley), layer index (top and bottom layer), and sublattice index (A and B).  
The whole noninteracting Hamiltonian is a block diagonal matrix composing of two terms in the spin spac $s=\uparrow,\downarrow$. Namely, $H_{0}(r) = diag(h_{\uparrow},h_{\downarrow})$, and there is no coupling between opposite spins.  
For each spin $h_{s}$, it is a block diagonal matrix composing of two terms in the valley space $\tau=\pm K$. Namely, $h_{s}=diag(h_{s,+K}, h_{s,-K})$, and there is no inter valley coupling.  
For each valley $h_{s,\tau}$, it is a matrix composing of two terms in the layer space $l=t,b$. Namely, $`h_{s,\tau}=\begin{bmatrix} h_{\theta/2}(k) & h_T(r)\\ h_T^\dagger(r) & h_{-\theta/2}(k) \end{bmatrix}`$. Here each matrix element in $h_{s,\tau}$ is a 2 by 2 matrix which will be specified later.
Express the noninteracting Hamiltonian $H_{0}(r)$ using $h_{s,\tau}$ in the matrix form, and arrange the basis in the order of (up,+K,top,A),(up,+K,top,B),(up,+K,bottom,A),(up,+K,bottom,B),(up,-K,top,A),(up,-K,top,B),(up,-K,bottom,A),(up,-K,bottom,B),(down,+K,top,A),(down,+K,top,B),(down,+K,bottom,A),(down,+K,bottom,B),(down,-K,top,A),(down,-K,top,B),(down,-K,bottom,A),(down,-K,bottom,B).


Use the following conventions for the symbols:  
$s$ : spin index   
$\uparrow$ : spin up   
$\downarrow$ : spin down   
$l$ : layer index   
$t$ : top layer  
$b$ : bottom layer  
$\tau$ : valley index  
$+K$ : +K valley  
$-K$ : -K valley  
$\alpha$ : sublattice index  
$A$ : A subllatice  
$B$ : B subllatice  
$k$ : momentum operator  
$h_{s}$ : Hamiltonian for spin $s$
$h_{s,\tau}$: Hamiltonian for spin $s$ at valley $\tau$ 
$diag(..)$: diagonal matrix 
$h_{\theta/2}(k)$: Dirac Hamiltonians for isolated rotated graphene layers
$h_T(r)$: interlayer tunneling Hamiltonian

**Completion:**  
Following your instructions, the noninteracting Hamiltonian $H_{0}(r)$ in real space and in the single-particle form, considering all degrees of freedom, is given by:

$$
H_{0}(r) = \left[ 
\begin{array}{cccccccccccccccc}
h_{\theta/2}(k) & h_T(r) & 0 & 0 & 0 & 0 & 0 & 0 \\
h_T^\dagger(r) & h_{-\theta/2}(k) & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & h_{\theta/2}(k) & h_T(r) & 0 & 0 & 0 & 0 \\
0 & 0 & h_T^\dagger(r) & h_{-\theta/2}(k) & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & h_{\theta/2}(k) & h_T(r) & 0 & 0 \\
0 & 0 & 0 & 0 & h_T^\dagger(r) & h_{-\theta/2}(k) & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & h_{\theta/2}(k) & h_T(r) \\
0 & 0 & 0 & 0 & 0 & 0 & h_T^\dagger(r) & h_{-\theta/2}(k) \\
\end{array}
\right]
$$

This is an 8x8 matrix, with each 2x2 block representing $h_{s,\tau}$ for one combination of spin ($\uparrow$ or $\downarrow$), valley ($+K$ or $-K$), and layer ($t$ or $b$). Each element of these 2x2 matrices will further be 2x2 matrices representing the A and B sublattices. This structure then repeats for the next spin component, forming the overall 16x16 matrix structure you described.



## Define each term in noninteracting Hamiltonian (continuum version) [why k' in bottom layer, too long output, exceed max token]
**Prompt:**  
Now you will be instructed to construct each term in the matrix, namely the energy dispersion $h_{\theta/2}(k)$, and $h_T(r)$.  
For the top layer $h_{\theta/2}(k)$ , it can be decomposed into a matrix composing of two terms in the sublattice space $\alpha=A,B$. Namely, $`h_{\theta/2}(k)=-\hbar v_D |\bar{k}| \begin{pmatrix}  0 & e^{i(\theta_{\bar{k}}-\theta/2)}\\ e^{-i(\theta_{\bar{k}}-\theta/2)} & 0 \end{pmatrix}`$, here $\bar{k}= k-K_{\theta/2}$  
For the bottom layer $h_{-\theta/2}(k)$, it can be decomposed into a matrix composing of two terms in the sublattice space $\alpha=A,B$. Namely, $`h_{-\theta/2}(k)=-\hbar v_D |\bar{k}| \begin{pmatrix}  0 & e^{i(\theta_{\bar{k}}+\theta/2)}\\ e^{-i(\theta_{\bar{k}}+\theta/2)} & 0 \end{pmatrix}`$, here $\bar{k}= k-K_{-\theta/2}$   
For the interlayer tunneling $h_T(r)$, it can be de composed into a matrix composing of two terms in in the sublattice space $\alpha=A,B$. Namely, $h_T(r)=\sum_{j=0,1,2} T_j e^{- i q_j r}$, where $T_j=\omega_0 \sigma_0 + \omega_1 \cos(j\phi)\sigma_x + \omega_1 \sin(j\phi)\sigma_y$.  
You should expand the summation and $\sigma$ matrix in $h_T(r)$ to obtain a 2 by 2 matrix.
Finally, in the real space, the momentum $k=-i \partial_r$. You should keep the form of $k$ in the Hamiltonian for short notations but should remember $k$ is an operator.  
Return $h_{\theta/2}(k)$, $h_{-\theta/2}(k)$ and $h_T(r)$ in the 2 by 2 matrix form.

Use the following conventions for the symbols (You should also obey the conventions in all my previous prompts if you encounter undefined symbols. If you find it is never defined or has conflicts in the conventions, you should stop and let me know):  
$k$ : momentum operator  
$r$ : real space operator  
$\theta$ : twist angle  
$v_D$ : Fermi velocity  
$\omega_i$ :  magnitude of interlayer tunneling, i=0,1,2  
$\sigma_0$: Pauli Matrix 0 $`\sigma_0 = \begin{bmatrix} 1 & 0 \\ 0 & 1\end{bmatrix}`$  
$\sigma_x$: Pauli Matrix x $`\sigma_x = \begin{bmatrix} 0 & 1 \\ 1 & 0\end{bmatrix}`$  
$\sigma_y$: Pauli Matrix y $`\sigma_y = \begin{bmatrix} 0 & -i \\ i & 0\end{bmatrix}`$  
$q_j$: momentum boost 

**Completion:**  

Following your instructions, let's start with expanding $h_{\theta/2}(k)$, $h_{-\theta/2}(k)$, and $h_T(r)$:

1. $h_{\theta/2}(k)=-\hbar v_D |\bar{k}| \begin{pmatrix}  0 & e^{i(\theta_{\bar{k}}-\theta/2)}\\ e^{-i(\theta_{\bar{k}}-\theta/2)} & 0 \end{pmatrix}$, where $\bar{k}= k-K_{\theta/2}$

2. $h_{-\theta/2}(k)=-\hbar v_D |\bar{k}| \begin{pmatrix}  0 & e^{i(\theta_{\bar{k}}+\theta/2)}\\ e^{-i(\theta_{\bar{k}}+\theta/2)} & 0 \end{pmatrix}$, where $\bar{k}= k-K_{-\theta/2}$

3. For the interlayer tunneling, we have $h_T(r)=\sum_{j=0,1,2} T_j e^{- q_j r}$, where $T_j=\omega_0 \sigma_0 + \omega_1 \cos(j\phi)\sigma_x + \omega_1 \sin(j\phi)\sigma_y$. Therefore, after expanding the summation:

$h_T(r)= \left(\omega_0 \sigma_0 + \omega_1 \cos(\phi)\sigma_x + \omega_1 \sin(\phi)\sigma_y \right) e^{- q_0 r}+ \left(\omega_0 \sigma_0 + \omega_1 \cos(2\phi)\sigma_x + \omega_1 \sin(2\phi)\sigma_y \right) e^{- q_1 r}+ \left(\omega_0 \sigma_0 + \omega_1 \cos(3\phi)\sigma_x + \omega_1 \sin(3\phi)\sigma_y \right) e^{- q_2 r}$

Substituting these matrices into the Hamiltonian $H_{0}(r)$, we obtain the final 16x16 matrix:

$H_{0}(r) = \left[ 
\begin{array}{cccccccccccccccc}
h_{\theta/2}(k) & h_T(r) & 0 & 0 & 0 & 0 & 0 & 0 \\
h_T^\dagger(r) & h_{-\theta/2}(k) & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & h_{\theta/2}(k) & h_T(r) & 0 & 0 & 0 & 0 \\
0 & 0 & h_T^\dagger(r) & h_{-\theta/2}(k) & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & h_{\theta/2}(k) & h_T(r) & 0 & 0 \\
0 & 0 & 0 & 0 & h_T^\dagger(r) & h_{-\theta/2}(k) & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & h_{\theta/2}(k) & h_T(r) \\
0 & 0 & 0 & 0 & 0 & 0 & h_T^\dagger(r) & h_{-\theta/2}(k) \\
\end

{array}
\right]$

where $k=-i \partial_r$ is the momentum operator. The actual operations in real space will be performed when applying this Hamiltonian operator to a wavefunction or a state. 

Each block in this Hamiltonian is now a 2x2 matrix, and they together form the 16x16 Hamiltonian matrix in the real space. Please let me know if you have further instructions.




## Construct interaction Hamiltonian (momentum space)
**Prompt:**  
Now you will be instructed to construct the interaction part of the Hamiltonian $\hat{H}^{int}$ in the momentum space.  
The interaction Hamiltonian is a product of four parts.
The first part is the product of four operators with two creation and two annihilation operators following the normal order, namely, creation operators are before annihilation operators. The two creation operators carry the spin index of $\sigma_1$ and $\sigma_2$, and $b_1$, $b_2$, $b_3$, $b_4$ for the moire reciprocal lattice vectors. The two annihilation operators have the same valley index and layer index. You should follow the order of $1,2,2,1$ for the spin index, $1,2,3,4$ for the moire reciprocal lattice vectors, and $k_1$ to $k_4$ for the momentum.  
The second part is the constraint of total momentum conservation, namely the total momentum of all creation operators should be the same as that of all annihilation operators. For each operator, the total momentum is the sum of moire reciprocal lattice $b_i$ and momentum with in the first BZ $k_i$.  
The third part is the interaction form. You should use the bare Coulomb interaction $V(q)=2\pi e^2/(\epsilon |q|)$, where $q$ is the transferred momentum between a creation operator and an annilation operator with the same spin $\tau_i$.  
The fourth part is the normalization factor, you should use $\frac{1}{2 N V}$ here.
Finally, the summation should be running over all spin index, moire reciprocal lattice index, and momentum.
Return the interaction term $\hat{H}^{int}$ in terms of $c_{\sigma,b}(k)$ and $V(q)$ (with $q$ expressed in terms of $k_i$ and $b_i$).

Use the following conventions for the symbols (You should also obey the conventions in all my previous prompts if you encounter undefined symbols. If you find it is never defined or has conflicts in the conventions, you should stop and let me know):  
$\epsilon$ : dielectric constant  
$V(q)$ : bare Coulomb interaction in the momentum space